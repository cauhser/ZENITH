console.log('ZENITH Wellness permission request loaded');document.addEventListener('DOMContentLoaded', () => {    const contentAnalysisCheckbox = document.getElementById('contentAnalysis');    const eyeTrackingCheckbox = document.getElementById('eyeTracking');    const emotionDetectionCheckbox = document.getElementById('emotionDetection');    const dataCollectionCheckbox = document.getElementById('dataCollection');    const grantBtn = document.getElementById('grantBtn');    const denyBtn = document.getElementById('denyBtn');    const statusMessage = document.getElementById('statusMessage');    initPermissionRequest();    grantBtn.addEventListener('click', handlePermissionGrant);    denyBtn.addEventListener('click', handlePermissionDeny);    dataCollectionCheckbox.addEventListener('change', (e) => {        if (!e.target.checked) {            showStatus('Data collection is required to use ZENITH Wellness features. Your data stays on your device.', 'error');            setTimeout(() => {                dataCollectionCheckbox.checked = true;            }, 100);        }    });    contentAnalysisCheckbox.addEventListener('change', updateGrantButton);    eyeTrackingCheckbox.addEventListener('change', updateGrantButton);    emotionDetectionCheckbox.addEventListener('change', updateGrantButton);    dataCollectionCheckbox.addEventListener('change', updateGrantButton);});function initPermissionRequest() {    console.log('Initializing permission request...');    if (typeof chrome === 'undefined' || !chrome.runtime) {        showStatus('Error: This page must be opened as a Chrome extension.', 'error');        disableAllControls();        return;    }    loadExistingPermissions();}function loadExistingPermissions() {    chrome.runtime.sendMessage({ type: 'GET_PERMISSIONS' }, (response) => {        if (chrome.runtime.lastError) {            console.error('Error loading permissions:', chrome.runtime.lastError);            showStatus('Error connecting to extension. Please try refreshing the page.', 'error');            return;        }        if (response && response.permissions) {            const permissions = response.permissions;            if (permissions.contentAnalysis !== undefined) {                document.getElementById('contentAnalysis').checked = permissions.contentAnalysis;            }            if (permissions.eyeTracking !== undefined) {                document.getElementById('eyeTracking').checked = permissions.eyeTracking;            }            if (permissions.emotionDetection !== undefined) {                document.getElementById('emotionDetection').checked = permissions.emotionDetection;            }            if (permissions.dataCollection !== undefined) {                document.getElementById('dataCollection').checked = permissions.dataCollection;            }            updateGrantButton();            console.log('Loaded existing permissions:', permissions);            if (permissions.permissionsAsked) {                showStatus('You can modify your existing permissions here.', 'info');                document.querySelector('.header h1').textContent = 'ðŸ§  ZENITH Wellness - Manage Permissions';                document.querySelector('.header p').textContent = 'Update your privacy settings and feature preferences';                document.getElementById('grantBtn').textContent = 'Update Permissions';            }        }    });}function handlePermissionGrant() {    console.log('User requested to grant permissions');    setButtonsEnabled(false);    showStatus('Processing your request...', 'info');    const requestedPermissions = {        contentAnalysis: document.getElementById('contentAnalysis').checked,        eyeTracking: document.getElementById('eyeTracking').checked,        emotionDetection: document.getElementById('emotionDetection').checked,        dataCollection: document.getElementById('dataCollection').checked,        permissionsAsked: true,        grantedAt: new Date().toISOString(),        grantedFrom: 'permission-request-page'    };    if (!requestedPermissions.dataCollection) {        showStatus('Data collection is required to use ZENITH Wellness features. Your data stays securely on your device.', 'error');        setButtonsEnabled(true);        return;    }    if (!requestedPermissions.contentAnalysis && !requestedPermissions.eyeTracking && !requestedPermissions.emotionDetection) {        showStatus('Please enable at least one feature to continue.', 'error');        setButtonsEnabled(true);        return;    }    chrome.runtime.sendMessage({        type: 'REQUEST_PERMISSIONS',        permissions: requestedPermissions    }, (response) => {        if (chrome.runtime.lastError) {            console.error('Error sending permissions:', chrome.runtime.lastError);            showStatus('Error saving permissions. Please try again.', 'error');            setButtonsEnabled(true);            return;        }        if (response && response.success) {            console.log('Permissions granted successfully:', response.permissions);            showStatus('âœ… Permissions granted! ZENITH Wellness is now active.', 'success');            document.querySelector('.header h1').textContent = 'ðŸŽ‰ Permissions Granted!';            document.querySelector('.header p').textContent = 'ZENITH Wellness is now active and ready to help you.';            grantBtn.textContent = 'Continue to Dashboard';            grantBtn.onclick = redirectToDashboard;            denyBtn.style.display = 'none';            setTimeout(redirectToDashboard, 3000);            notifyTabsAboutPermissions(response.permissions);        } else {            showStatus('Error: Could not save permissions. Please try again.', 'error');            setButtonsEnabled(true);        }    });}function handlePermissionDeny() {    console.log('User denied permissions');    const minimalPermissions = {        contentAnalysis: false,        eyeTracking: false,        emotionDetection: false,        dataCollection: false,        permissionsAsked: true,        deniedAt: new Date().toISOString()    };    chrome.runtime.sendMessage({        type: 'REQUEST_PERMISSIONS',        permissions: minimalPermissions    }, (response) => {        if (chrome.runtime.lastError) {            console.error('Error saving denial:', chrome.runtime.lastError);        }        showStatus('Permissions not granted. You can enable ZENITH Wellness anytime by clicking the extension icon.', 'info');        document.querySelector('.header h1').textContent = 'Permissions Not Granted';        document.querySelector('.header p').textContent = 'You can enable ZENITH Wellness features anytime from the extension popup.';        grantBtn.textContent = 'Try Again';        grantBtn.onclick = () => window.location.reload();        denyBtn.style.display = 'none';        setTimeout(() => {            window.close();        }, 3000);    });}function redirectToDashboard() {    chrome.tabs.create({        url: 'http:        active: true    }, (tab) => {        console.log('Opened dashboard tab:', tab.id);        setTimeout(() => {            window.close();        }, 1000);    });}function notifyTabsAboutPermissions(permissions) {    chrome.tabs.query({}, (tabs) => {        let notifiedCount = 0;        tabs.forEach(tab => {            if (tab.url && tab.url.startsWith('http')) {                chrome.tabs.sendMessage(tab.id, {                    type: 'PERMISSIONS_UPDATED',                    permissions: permissions                }).then(() => {                    notifiedCount++;                    console.log(`Notified tab ${tab.id} about permissions`);                }).catch(error => {                    console.log(`Could not notify tab ${tab.id}:`, error.message);                });            }        });        console.log(`Permission update sent to ${notifiedCount} tabs`);    });}function updateGrantButton() {    const dataCollectionChecked = document.getElementById('dataCollection').checked;    const hasFeatureSelected = document.getElementById('contentAnalysis').checked ||                              document.getElementById('eyeTracking').checked ||                              document.getElementById('emotionDetection').checked;    const grantBtn = document.getElementById('grantBtn');    if (dataCollectionChecked && hasFeatureSelected) {        grantBtn.disabled = false;        grantBtn.style.opacity = '1';        grantBtn.style.cursor = 'pointer';    } else {        grantBtn.disabled = true;        grantBtn.style.opacity = '0.6';        grantBtn.style.cursor = 'not-allowed';    }}function showStatus(message, type) {    const statusMessage = document.getElementById('statusMessage');    statusMessage.textContent = message;    statusMessage.className = 'status-message';    switch (type) {        case 'success':            statusMessage.classList.add('status-success');            break;        case 'error':            statusMessage.classList.add('status-error');            break;        case 'info':            statusMessage.style.background = '#fef3c7';            statusMessage.style.color = '#92400e';            statusMessage.style.border = '1px solid #fde68a';            break;    }    statusMessage.style.display = 'block';    if (type === 'success') {        setTimeout(() => {            statusMessage.style.display = 'none';        }, 5000);    }}function setButtonsEnabled(enabled) {    const grantBtn = document.getElementById('grantBtn');    const denyBtn = document.getElementById('denyBtn');    grantBtn.disabled = !enabled;    denyBtn.disabled = !enabled;    if (enabled) {        grantBtn.style.opacity = '1';        denyBtn.style.opacity = '1';        grantBtn.style.cursor = 'pointer';        denyBtn.style.cursor = 'pointer';    } else {        grantBtn.style.opacity = '0.6';        denyBtn.style.opacity = '0.6';        grantBtn.style.cursor = 'not-allowed';        denyBtn.style.cursor = 'not-allowed';    }}function disableAllControls() {    const checkboxes = document.querySelectorAll('input[type="checkbox"]');    const buttons = document.querySelectorAll('button');    checkboxes.forEach(checkbox => {        checkbox.disabled = true;    });    buttons.forEach(button => {        button.disabled = true;        button.style.opacity = '0.6';        button.style.cursor = 'not-allowed';    });}document.addEventListener('visibilitychange', () => {    if (!document.hidden) {        loadExistingPermissions();    }});window.addEventListener('beforeunload', () => {    console.log('Permission request page closing');});if (typeof module !== 'undefined' && module.exports) {    module.exports = {        initPermissionRequest,        handlePermissionGrant,        handlePermissionDeny,        updateGrantButton,        showStatus    };}